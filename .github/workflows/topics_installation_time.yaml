name: Install benchmark (topics)

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - main

jobs:
  benchmark:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, windows-latest]

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"

      # Set a clean R library folder for the run (works across OS)
      - name: Set clean R library path
        run: |
          echo "R_LIBS_USER=${RUNNER_TEMP}/Rlib" >> $GITHUB_ENV
        shell: bash

      # Linux deps incl Java (required for rJava/mallet used by topicsModel)
      - name: Linux system deps (incl Java for rJava/mallet)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            default-jdk \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
            libharfbuzz-dev libfribidi-dev libcairo2-dev libgit2-dev
          sudo R CMD javareconf
        shell: bash

      # macOS: ensure Java exists for rJava/mallet
      - name: macOS Java deps (for rJava/mallet)
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install --cask temurin || true
          /Library/Java/JavaVirtualMachines/temurin*.jdk/Contents/Home/bin/java -version || true
        shell: bash

      - name: Benchmark install (topics)
        run: |
          # Ensure R uses the user library FIRST (fixes Linux /opt/R not writable)
          userlib <- Sys.getenv("R_LIBS_USER")
          dir.create(userlib, recursive = TRUE, showWarnings = FALSE)
          .libPaths(c(userlib, .libPaths()))

          cat("R_LIBS_USER:", userlib, "\n")
          cat("libPaths:\n"); print(.libPaths())

          run_timed <- function(label, expr) {
            gc()
            t0 <- Sys.time()
            force(expr)
            t1 <- Sys.time()
            secs <- as.numeric(difftime(t1, t0, units = "secs"))
            cat(sprintf("\nBENCHMARK|%s|%.1f seconds\n", label, secs))
            return(secs)
          }

          repos <- "https://cloud.r-project.org"

          # Always specify lib=userlib to avoid installing into system lib on Linux
          run_timed("install_remotes",
                    install.packages("remotes", repos = repos, lib = userlib))

          # Small prereqs you had before (keep httr; DROP arrow to avoid long Linux source builds)
          t_prereqs <- run_timed(
            "install_prereqs_httr",
            install.packages(c("httr"), repos = repos, lib = userlib)
          )

          # Java-dependent deps needed for topicsModel() path you are testing
          t_java_pkgs <- run_timed(
            "install_rJava_mallet",
            install.packages(c("rJava", "mallet"), repos = repos, lib = userlib)
          )

          library(remotes, lib.loc = userlib)

          t_topics <- run_timed(
            "install_topics_from_github",
            remotes::install_github(
              "theharmonylab/topics",
              upgrade = "never",
              dependencies = TRUE,
              lib = userlib
            )
          )

          t_test <- run_timed(
            "topics_smoke_test",
            {
              library(topics, lib.loc = userlib)
              dtm <- topicsDtm(data = c("This is a test document.", "This is another test."))
              res <- topicsModel(dtm)
              print(res)
            }
          )

          out <- data.frame(
            os = Sys.info()[["sysname"]],
            r_version = as.character(getRversion()),
            install_prereqs_s = t_prereqs,
            install_rJava_mallet_s = t_java_pkgs,
            install_topics_from_github_s = t_topics,
            smoke_test_s = t_test,
            total_s = t_prereqs + t_java_pkgs + t_topics + t_test
          )
          print(out)

          dir.create("bench", showWarnings = FALSE)
          write.csv(out, file = "bench/install-benchmark.csv", row.names = FALSE)
        shell: Rscript {0}

      - name: Upload benchmark artifact
        uses: actions/upload-artifact@v4
        with:
          name: install-benchmark-topics-${{ matrix.os }}
          path: bench/install-benchmark.csv